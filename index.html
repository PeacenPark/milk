<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜¨,ê²¸ ìˆ˜ìœ ì¼ì§€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#4caf50">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; font-size: 18px; padding: 20px; max-width: 600px; margin: auto; background: #f5f5f5; }
    label, select, input, textarea, button { font-size: 18px; width: 100%; margin-top: 10px; padding: 10px; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; font-size: 16px; text-align: center; }
    input[type="checkbox"] { width: auto; }
    #dailySummaryBox { margin-top: 20px; background: #e0f7fa; padding: 10px; border-radius: 5px; }
    #infoTable { width: 100%; margin-top: 15px; border-collapse: collapse; background: #e8f5e9; border: 1px solid #c8e6c9; font-size: 20px; text-align: center; }
    #infoTable td { padding: 10px; border: 1px solid #c8e6c9; }
    #infoTable span { font-weight: bold; color: #2e7d32; font-size: 20px; }
    #dateSelect { position: absolute; top: 10px; right: 10px; width: 120px; font-size: 14px; }
    #baby { width: 100px; font-size: 25px; }
    #weight, #temperature { width: 80px; height: 40px; }
    h2 { text-align: center; font-size: 30px; font-weight: bold; }
  </style>
</head>
<body onload="updateHeaderInfo()">

<h2 id="titleArea">
  ì˜¨,ê²¸ ìˆ˜ìœ ì¼ì§€
  <span id="dday" style="font-size: 16px; color: #555;"></span>
</h2>

<select id="dateSelect" onchange="loadLogs()"></select>
<select id="baby" onchange="loadLogs(); drawChart();">
  <option value="ë°• ì˜¨">ë°• ì˜¨</option>
  <option value="ë°• ê²¸">ë°• ê²¸</option>
</select>

<table id="infoTable"><tr><td><span id="nextFeedTime">-</span></td></tr></table>

<div style="display:flex; gap:10px;">
  <input type="date" id="inputDate" style="flex:1;">
  <input type="time" id="time" style="flex:1;">
</div>

<div style="display: flex; align-items: center; gap: 10px;">
  <select id="feedAmount" style="flex-grow: 1; font-size: 25px; padding: 10px;">
    <option value="">ìˆ˜ìœ ëŸ‰ (mL)</option>
    ${[...Array(18)].map((_, i) => {
      const val = 30 + i * 10;
      return `<option value="${val}" ${val === 160 ? 'selected' : ''}>${val} mL</option>`;
    }).join('')}
  </select>
</div>

<select id="poopType">
  <option value="">ëŒ€ë³€</option>
  <option value="ì •ìƒ">ì •ìƒ</option>
  <option value="ëœë³€">ëœë³€</option>
  <option value="ë¬½ì€ë³€">ë¬½ì€ë³€</option>
  <option value="ì„¤ì‚¬">ì„¤ì‚¬</option>
</select>

<label><input type="checkbox" id="pee" /> ì†Œë³€</label>
<button onclick="saveLog()">ê¸°ë¡ ì €ì¥</button>

<div id="dailySummaryBox"></div>

<table>
  <thead><tr><th>ëª¸ë¬´ê²Œ(kg)</th><th>ì²´ì˜¨(â„ƒ)</th><th>ëª©ìš•</th><th>ì €ì¥</th></tr></thead>
  <tbody><tr>
    <td><input type="number" id="weight" step="0.1" /></td>
    <td><input type="number" id="temperature" step="0.1" /></td>
    <td><input type="checkbox" id="bathed" /></td>
    <td><button onclick="saveDailyNote()">ì €ì¥</button></td>
  </tr></tbody>
</table>

<input type="text" id="memo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />

<table>
  <thead><tr><th>ì‹œê°„</th><th>ìˆ˜ìœ ëŸ‰</th><th>ëŒ€ë³€</th><th>ì†Œë³€</th><th>ê´€ë¦¬</th></tr></thead>
  <tbody id="logTable"><tr><td colspan="5">ê¸°ë¡ ì—†ìŒ</td></tr></tbody>
</table>

<canvas id="feedChart" height="250"></canvas>

<script>
function to12HourFormat(timeStr) {
  const [hour, minute] = timeStr.split(':').map(Number);
  const ampm = hour >= 12 ? 'PM' : 'AM';
  const hour12 = hour % 12 || 12;
  return `${ampm} ${hour12}:${String(minute).padStart(2, '0')}`;
}

const firebaseConfig = {
  apiKey: "AIzaSyC4qCMBx1Xv5HpMXReTQjVy7uioihMY_Vw",
  authDomain: "milk-3aac7.firebaseapp.com",
  projectId: "milk-3aac7",
  storageBucket: "milk-3aac7.appspot.com",
  messagingSenderId: "429081947703",
  appId: "1:429081947703:web:2bbaf7160a4936434859b2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let userId = "", chartInstance = null;

firebase.auth().signInAnonymously().then(res => {
  userId = res.user.uid;
  loadDateList().then(() => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateSelect').value = today;
    document.getElementById('inputDate').value = today;
    setNowTime();
    loadLogs();
    drawChart();
  });
});

function updateHeaderInfo() {
  const ddayBase = new Date("2025-01-06");
  const today = new Date();
  const diff = Math.floor((today - ddayBase) / (1000 * 60 * 60 * 24));
  document.getElementById('dday').textContent = ` - ìƒí›„ ${diff}ì¼`;
  updateCurrentTime();
  setInterval(updateCurrentTime, 60000);
}

function updateCurrentTime() {
  const now = new Date();
  const hh = String(now.getHours()).padStart(2, '0');
  const mm = String(now.getMinutes()).padStart(2, '0');
  const currentTime = to12HourFormat(`${hh}:${mm}`);
}

function setNextFeedTimeLabel(timeStr) {
  const [h, m] = timeStr.split(':').map(Number);
  const dt = new Date();
  dt.setHours(h);
  dt.setMinutes(m + 210);
  const today = new Date().toISOString().split('T')[0];
  const label = (new Date().toISOString().split('T')[0] === today) ? `ë‹¤ìŒ ìˆ˜ìœ  ì‹œê°„: ${to12HourFormat(String(dt.getHours()).padStart(2, '0') + ':' + String(dt.getMinutes()).padStart(2, '0'))}` : "ë‹¤ìŒ ìˆ˜ìœ  ì‹œê°„: -";
  document.getElementById('nextFeedTime').textContent = label;
}

function setNowTime() {
  const now = new Date();
  document.getElementById('time').value = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
}

async function saveLog() {
  const baby = document.getElementById('baby').value;
  const date = document.getElementById('inputDate').value;
  const time = document.getElementById('time').value;
  const feedAmount = parseInt(document.getElementById('feedAmount').value) || 0;
  const poopType = document.getElementById('poopType').value;
  const pee = document.getElementById('pee').checked;

  if (feedAmount === 0 && !poopType && !pee) {
    alert("ìˆ˜ìœ ëŸ‰ ë˜ëŠ” ëŒ€ë³€/ì†Œë³€ ìƒíƒœ ì¤‘ í•˜ë‚˜ ì´ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  await db.collection("users").doc(userId).collection("logs").doc(date).collection(baby).add({
    time, feedAmount, poopType, pee, createdAt: new Date()
  });

  const today = new Date().toISOString().split('T')[0];
  if (date === today && feedAmount > 0) {
    setNextFeedTimeLabel(time);
  }

  document.getElementById('feedAmount').value = '';
  document.getElementById('poopType').value = '';
  document.getElementById('pee').checked = false;
  setNowTime();
  loadLogs();
  drawChart();
}

async function saveDailyNote() {
  const baby = document.getElementById('baby').value;
  const date = document.getElementById('dateSelect').value;
  const weight = parseFloat(document.getElementById('weight').value) || null;
  const temperature = parseFloat(document.getElementById('temperature').value) || null;
  const bathed = document.getElementById('bathed').checked;
  const memo = document.getElementById('memo').value;

  const ref = db.collection("users").doc(userId).collection("daily").doc(date);
  const doc = await ref.get();
  const data = doc.exists ? doc.data() : {};
  data[baby] = { weight, temperature, bathed, memo };
  await ref.set(data);
  alert("í•˜ë£¨ ì¼ì§€ ì €ì¥ ì™„ë£Œ!");
}

async function loadDateList() {
  const select = document.getElementById('dateSelect');
  select.innerHTML = '';
  const snapshot = await db.collection("users").doc(userId).collection("logs").get();
  const dates = snapshot.docs.map(doc => doc.id).sort().reverse();
  dates.forEach(date => {
    const opt = document.createElement('option');
    opt.value = date;
    opt.textContent = date;
    select.appendChild(opt);
  });
}

function loadLogs() {
  const baby = document.getElementById('baby').value;
  const date = document.getElementById('dateSelect').value;
  const today = new Date().toISOString().split('T')[0];
  const isToday = (date === today);
  document.getElementById('inputDate').value = date;
  const tbody = document.getElementById('logTable');
  tbody.innerHTML = '';

  db.collection("users").doc(userId).collection("logs").doc(date).collection(baby)
    .orderBy("createdAt", "desc")
    .onSnapshot(async snap => {
      let totalFeed = 0, poopCount = 0, peeCount = 0, latestFeedTime = null;
      tbody.innerHTML = '';

      snap.forEach(doc => {
        const d = doc.data();
        const feedAmount = parseInt(d.feedAmount);
        if (!isNaN(feedAmount)) {
          totalFeed += feedAmount;
          if (feedAmount > 0 && !latestFeedTime) latestFeedTime = d.time;
        }
        if (d.poopType) poopCount++;
        if (d.pee) peeCount++;

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${to12HourFormat(d.time)}</td>
                        <td>${isNaN(feedAmount) ? '-' : feedAmount + 'mL'}</td>
                        <td>${d.poopType || '-'}</td>
                        <td>${d.pee ? 'O' : ''}</td>
                        <td><button onclick="editLog('${doc.id}')">âœï¸</button>
                            <button onclick="deleteLog('${doc.id}')">ğŸ—‘</button></td>`;
        tbody.appendChild(tr);
      });

      document.getElementById('dailySummaryBox').innerHTML =
        `<strong>${date} ${baby} í†µê³„</strong><br>ìˆ˜ìœ ëŸ‰: ${totalFeed}mL, ëŒ€ë³€ ${poopCount}íšŒ, ì†Œë³€ ${peeCount}íšŒ`;

      if (isToday && latestFeedTime) {
        setNextFeedTimeLabel(latestFeedTime);
      } else {
        document.getElementById('nextFeedTime').textContent = "ë‹¤ìŒ ìˆ˜ìœ  ì‹œê°„: -";
      }

      const noteSnap = await db.collection("users").doc(userId).collection("daily").doc(date).get();
      if (noteSnap.exists && noteSnap.data()[baby]) {
        const n = noteSnap.data()[baby];
        document.getElementById('weight').value = n.weight || '';
        document.getElementById('temperature').value = n.temperature || '';
        document.getElementById('bathed').checked = n.bathed || false;
        document.getElementById('memo').value = n.memo || '';
      } else {
        document.getElementById('weight').value = '';
        document.getElementById('temperature').value = '';
        document.getElementById('bathed').checked = false;
        document.getElementById('memo').value = '';
      }
    });
}

async function drawChart() {
  const baby = document.getElementById('baby').value;
  const logsRef = db.collection("users").doc(userId).collection("logs");
  const dateDocs = await logsRef.get();
  const dateList = dateDocs.docs.map(doc => doc.id).sort();
  const feedTotals = [];

  for (let date of dateList) {
    const snap = await logsRef.doc(date).collection(baby).get();
    let total = 0;
    snap.forEach(doc => {
      const amt = parseInt(doc.data().feedAmount);
      if (!isNaN(amt)) total += amt;
    });
    feedTotals.push(total);
  }

  const ctx = document.getElementById('feedChart').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dateList,
      datasets: [{
        label: `${baby} ìˆ˜ìœ ëŸ‰ (mL)`,
        data: feedTotals,
        backgroundColor: 'rgba(75,192,192,0.6)',
        borderColor: 'rgba(75,192,192,1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
}

async function editLog(id) {
  const baby = document.getElementById('baby').value;
  const date = document.getElementById('dateSelect').value;
  const ref = db.collection("users").doc(userId).collection("logs").doc(date).collection(baby).doc(id);
  const doc = await ref.get();
  const data = doc.data();
  const newFeed = prompt("ìˆ˜ìœ ëŸ‰ (mL)", data.feedAmount);
  const newPoop = prompt("ëŒ€ë³€ ìƒíƒœ", data.poopType || '');
  const newPee = confirm("ì†Œë³€ ìˆì—ˆë‚˜ìš”?");
  await ref.update({
    feedAmount: parseInt(newFeed) || 0,
    poopType: newPoop,
    pee: newPee
  });
}

async function deleteLog(id) {
  if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;
  const baby = document.getElementById('baby').value;
  const date = document.getElementById('dateSelect').value;
  await db.collection("users").doc(userId).collection("logs").doc(date).collection(baby).doc(id).delete();
  loadLogs(); // ì¦‰ì‹œ ë°˜ì˜
}
</script>
</body>
</html>