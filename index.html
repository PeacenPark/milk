<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>온,겸 수유일지</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#4caf50">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; font-size: 18px; padding: 20px; max-width: 600px; margin: auto; background: #f5f5f5; }
    label, select, input, textarea, button { font-size: 18px; width: 100%; margin-top: 10px; padding: 10px; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; font-size: 16px; text-align: center; }
    input[type="checkbox"] { width: auto; }
    #dailySummaryBox { margin-top: 20px; background: #e0f7fa; padding: 10px; border-radius: 5px; }
    #infoTable { width: 100%; margin-top: 15px; border-collapse: collapse; background: #e8f5e9; border: 1px solid #c8e6c9; font-size: 20px; text-align: center; }
    #infoTable td { padding: 10px; border: 1px solid #c8e6c9; }
    #infoTable span { font-weight: bold; color: #2e7d32; font-size: 20px; }
    #dateSelect { position: absolute; top: 10px; right: 10px; width: 120px; font-size: 14px; }
    #baby { width: 100px; font-size: 25px; }
    #weight, #temperature { width: 80px; height: 40px; }
    h2 { text-align: center; font-size: 30px; font-weight: bold; }
  </style>
</head>
<body onload="updateHeaderInfo()">

<h2 id="titleArea">
  온,겸 수유일지
  <span id="dday" style="font-size: 16px; color: #555;"></span>
</h2>

<div id="currentTime" style="text-align:center; font-size: 20px; margin-bottom: 10px;"></div>

<select id="dateSelect" onchange="loadLogs()"></select>
<select id="baby" onchange="loadLogs(); drawChart();">
  <option value="박 온">박 온</option>
  <option value="박 겸">박 겸</option>
</select>

<table id="infoTable">
<tr><td><span id="nextFeedTime">-</span></td></tr>
</table>

<div style="display:flex; gap:10px;">
  <input type="date" id="inputDate" style="flex:1;">
  <input type="time" id="time" style="flex:1;">
</div>

<select id="feedAmount">
  <option value="">수유량 (mL)</option>
  ${[...Array(18)].map((_, i) => {
    const value = 30 + i * 10;
    return `<option value="${value}" ${value === 160 ? "selected" : ""}>${value} mL</option>`;
  }).join('')}
</select>

<select id="poopType">
  <option value="">대변</option>
  <option value="정상">정상</option>
  <option value="된변">된변</option>
  <option value="묽은변">묽은변</option>
  <option value="설사">설사</option>
</select>

<label><input type="checkbox" id="pee" /> 소변</label>
<button onclick="saveLog()">기록 저장</button>

<div id="dailySummaryBox"></div>

<table>
  <thead>
    <tr><th>몸무게(kg)</th><th>체온(℃)</th><th>목욕</th><th>저장</th></tr>
  </thead>
  <tbody>
    <tr>
      <td><input type="number" id="weight" step="0.1" /></td>
      <td><input type="number" id="temperature" step="0.1" /></td>
      <td><input type="checkbox" id="bathed" /></td>
      <td><button onclick="saveDailyNote()">저장</button></td>
    </tr>
  </tbody>
</table>

<input type="text" id="memo" placeholder="메모를 입력하세요" />

<table>
  <thead><tr><th>시간</th><th>수유량</th><th>대변</th><th>소변</th><th>관리</th></tr></thead>
  <tbody id="logTable"><tr><td colspan="5">기록 없음</td></tr></tbody>
</table>

<canvas id="feedChart" height="250"></canvas>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC4qCMBx1Xv5HpMXReTQjVy7uioihMY_Vw",
  authDomain: "milk-3aac7.firebaseapp.com",
  projectId: "milk-3aac7",
  storageBucket: "milk-3aac7.appspot.com",
  messagingSenderId: "429081947703",
  appId: "1:429081947703:web:2bbaf7160a4936434859b2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let userId = "", chartInstance = null;

firebase.auth().signInAnonymously().then(res => {
  userId = res.user.uid;
  loadDateList().then(() => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateSelect').value = today;
    document.getElementById('inputDate').value = today;
    setNowTime();
    loadLogs();
    drawChart();
  });
});

function updateHeaderInfo() {
  const ddayBase = new Date("2025-01-06");
  const today = new Date();
  const diff = Math.floor((today - ddayBase) / (1000 * 60 * 60 * 24));
  document.getElementById('dday').textContent = ` - 생후 ${diff}일`;
  updateCurrentTime();
  setInterval(updateCurrentTime, 60000);
}

function updateCurrentTime() {
  const now = new Date();
  const hh = String(now.getHours()).padStart(2, '0');
  const mm = String(now.getMinutes()).padStart(2, '0');
  const currentTimeEl = document.getElementById('currentTime');
  if (currentTimeEl) {
    currentTimeEl.textContent = `현재 시간: ${to12HourFormat(`${hh}:${mm}`)}`;
  }
}

function to12HourFormat(timeStr) {
  const [hour, minute] = timeStr.split(':').map(Number);
  const ampm = hour >= 12 ? 'PM' : 'AM';
  const hour12 = hour % 12 || 12;
  return `${ampm} ${hour12}:${String(minute).padStart(2, '0')}`;
}

function setNowTime() {
  const now = new Date();
  document.getElementById('time').value =
    String(now.getHours()).padStart(2, '0') + ':' +
    String(now.getMinutes()).padStart(2, '0');
}

async function saveLog() {
  const baby = document.getElementById('baby').value;
  const date = document.getElementById('inputDate').value;
  if (!date) {
    alert("날짜가 선택되지 않았습니다.");
    return;
  }
  const time = document.getElementById('time').value;
  const feedAmount = parseInt(document.getElementById('feedAmount').value) || 0;
  const poopType = document.getElementById('poopType').value;
  const pee = document.getElementById('pee').checked;

  if (feedAmount === 0 && !poopType && !pee) {
    alert("수유량 또는 대변/소변 상태 중 하나 이상을 입력해주세요.");
    return;
  }

  await db.collection("users").doc(userId).collection("logs").doc(date).collection(baby).add({
    time, feedAmount, poopType, pee, createdAt: new Date()
  });

  const today = new Date().toISOString().split('T')[0];
  if (date === today && feedAmount > 0) {
    setNextFeedTimeLabel(time);
  }

  document.getElementById('feedAmount').value = '';
  document.getElementById('poopType').value = '';
  document.getElementById('pee').checked = false;
  setNowTime();
  loadLogs();
  drawChart();
}

async function saveDailyNote() {
  const baby = document.getElementById('baby').value;
  const date = document.getElementById('dateSelect').value;
  if (!date) {
    alert("날짜가 선택되지 않았습니다.");
    return;
  }
  const weight = parseFloat(document.getElementById('weight').value) || null;
  const temperature = parseFloat(document.getElementById('temperature').value) || null;
  const bathed = document.getElementById('bathed').checked;
  const memo = document.getElementById('memo').value;

  const ref = db.collection("users").doc(userId).collection("daily").doc(date);
  const doc = await ref.get();
  const data = doc.exists ? doc.data() : {};
  data[baby] = { weight, temperature, bathed, memo };
  await ref.set(data);
  alert("하루 일지 저장 완료!");
}

async function loadDateList() {
  const select = document.getElementById('dateSelect');
  select.innerHTML = '';
  const snapshot = await db.collection("users").doc(userId).collection("logs").get();
  const dates = snapshot.docs.map(doc => doc.id).sort().reverse();
  dates.forEach(date => {
    const opt = document.createElement('option');
    opt.value = date;
    opt.textContent = date;
    select.appendChild(opt);
  });
}

function loadLogs() {
  const baby = document.getElementById('baby').value;
  const date = document.getElementById('dateSelect').value;
  if (!date) return; // 방어 코드 추가
  const today = new Date().toISOString().split('T')[0];
  const isToday = (date === today);
  document.getElementById('inputDate').value = date;
  const tbody = document.getElementById('logTable');
  tbody.innerHTML = '';
  // ... 나머지 동일
}
</script>
</body>
</html>
